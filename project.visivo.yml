sources:
  - name: nyc-db
    type: duckdb
    database: nyc_food.duckdb

defaults:
  source_name: nyc-db

models:
  - name: restaurants
    sql: SELECT * FROM restaurants_with_station

  - name: station-counts
    sql: >
      SELECT * FROM (
        SELECT *,
          ROW_NUMBER() OVER (PARTITION BY cuisine ORDER BY restaurant_count DESC) AS rank
        FROM station_cuisine_counts
      ) WHERE rank <= 3

  - name: cuisine-list
    sql: SELECT DISTINCT cuisine FROM restaurants_with_station ORDER BY cuisine

inputs:
  - name: cuisine-select
    label: "Select Cuisine"
    type: single-select
    options: ?{SELECT cuisine FROM ${ref(cuisine-list)}}
    display:
      type: dropdown

insights:
  - name: restaurant-markers
    props:
      type: scattermap
      lat: ?{${ref(restaurants).latitude}}
      lon: ?{${ref(restaurants).longitude}}
      text: ?{${ref(restaurants).restaurant_name} || ' - ' || ${ref(restaurants).address}}
      mode: markers
      marker:
        size: 7
        color: "#e74c3c"
        opacity: 0.7
      name: restaurants
    interactions:
      - filter: ?{${ref(restaurants).cuisine} = '${ref(cuisine-select).value}'}

  - name: station-bubbles
    props:
      type: scattermap
      lat: ?{${ref(station-counts).station_lat}}
      lon: ?{${ref(station-counts).station_lon}}
      text: ?{${ref(station-counts).station_name} || ' (' || ${ref(station-counts).station_routes} || ')'}
      mode: markers
      marker:
        size: ?{${ref(station-counts).restaurant_count}/16 + 10}
        color: "#3498db"
        opacity: 0.8
      name: subway-stations
    interactions:
      - filter: ?{${ref(station-counts).cuisine} = '${ref(cuisine-select).value}'}

charts:
  - name: cuisine-map
    insights:
      - ${ref(station-bubbles)}
      - ${ref(restaurant-markers)}
    layout:
      showlegend: false
      margin: {l: 0, r: 0, t: 0, b: 0}
      map:
        center:
          lat: 40.7128
          lon: -73.95
        zoom: 10

dashboards:
  - name: nyc-cuisine-dashboard
    rows:
      - height: compact
        items:
          - markdown:
              content: |
                # NYC Restaurant Cuisine Explorer
                Select a cuisine to see restaurants and best subway stops.
                Blue bubbles = subway stations (bigger = more restaurants nearby).
          - input: ${ref(cuisine-select)}
      - height: large
        items:
          - chart: ${ref(cuisine-map)}
